openapi: 3.1.0
info:
  title: Cycles Budget Authority API
  version: 0.1.0
  summary: v0 protocol for deterministic budget governance (reserve/commit) with optional decide + balance queries.
  description: |-
    PURPOSE (v0):
      - Provide a minimal, language-agnostic protocol to enforce deterministic spend exposure for agent runtimes
        via concurrency-safe reservations and idempotent commits.
      - Include optional integration endpoints: /decide (soft landing) and /balances (operator visibility).

    NON-GOALS (v0) (NORMATIVE):
      - Budget establishment and funding operations are out of scope for v0.
        v0 defines the reservation/commit/release enforcement plane and balance reporting only.
      - v0 provides no API for budget CRUD (create/update/delete), allocation setting, credit/deposit, or debit/withdrawal.
        Implementations MAY provide these via an operator/admin plane or a separate API; future versions may standardize them.
      - A reservation lifecycle is denominated in exactly one unit (single-unit reserve/commit/release).
        Multi-unit atomic reservation/settlement is a v1+ concern.

    AUTH & TENANCY (NORMATIVE):
      - Requests are authenticated via X-Cycles-API-Key.
      - Server determines an "effective tenant" from the API key (or other auth context).
      - Subject.tenant is a budgeting dimension and MUST be validated against the effective tenant.
        If validated and mismatched, server MUST return 403 FORBIDDEN.
      - Reservation ownership MUST be enforced: every reservation is bound to the effective tenant at creation.
        Any subsequent GET/commit/release for a reservation that exists but is owned by a different tenant
        MUST return 403 FORBIDDEN.
      - Balance visibility MUST be tenant-scoped: the server MUST only return balances within the effective tenant.
        If a request attempts to query another tenant (e.g., tenant filter mismatches), server MUST return 403 FORBIDDEN.

    EVOLUTION CONTRACT:
      - This API starts at v0.1.0 with /v1 paths to avoid future client churn.
      - v1+ evolution MUST be backward-compatible by default: new fields are additive, existing field meanings MUST NOT change.
      - Breaking changes (e.g., new required fields, semantic changes) require a new major API path (e.g., /v2).

    CORE INVARIANTS:
      - Reserve is atomic across all derived scopes.
      - Commit and release are idempotent.
      - No double-charge on retries (idempotency key enforced).

    ERROR SEMANTICS (NORMATIVE):
      - Budget denials MUST return HTTP 409 with error=BUDGET_EXCEEDED.
      - Finalized reservations MUST return HTTP 409 with error=RESERVATION_FINALIZED.
      - Expired reservations (beyond grace period) MUST return HTTP 410 with error=RESERVATION_EXPIRED.
      - Reservations that never existed MUST return HTTP 404 with error=NOT_FOUND.
      - HTTP 429 is reserved for server-side throttling/rate limiting (optional in v0), not deterministic budget exhaustion.
      - Unit mismatch on commit (actual.unit ≠ reservation unit) or event (actual.unit not supported for the target scope) MUST return HTTP 400 with error=UNIT_MISMATCH

    IDEMPOTENCY (NORMATIVE):
      - If X-Idempotency-Key header is present and body.idempotency_key is present, they MUST match.
      - Server MUST enforce idempotency per (effective tenant, endpoint, idempotency_key).
      - On replay of an idempotent request that previously succeeded, server MUST return the original successful
        response payload (including any server-generated identifiers such as reservation_id).
      - If the same key is reused with a different request payload, server MUST return 409 IDEMPOTENCY_MISMATCH.
      - Servers SHOULD compare idempotency payloads using a canonical JSON representation
        (e.g., RFC 8785 JSON Canonicalization Scheme) or an equivalent stable serialization.

    SCOPE DERIVATION (NORMATIVE):
      - Server derives canonical scope identifiers and a canonical scope_path from Subject fields.
      - Canonical ordering is: tenant → workspace → app → workflow → agent → toolGroup.
      - affected_scopes returned by the server MUST be in that canonical order.

    RESERVATION LEASING (GUIDANCE):
      - To mitigate "zombie reservations" (client crash after reserve), SDKs SHOULD:
        * keep ttl_ms short (typically 10s–30s),
        * include modest estimation buffers when using overage_policy=REJECT,
        * reserve in small initial leases and increase gradually ("slow start") for long or bursty operations,
        * prefer chunked reserve/commit cycles for long-running actions rather than a single large reservation.

servers:
  - url: https://api.cycles.local
    description: Default server (example)

tags:
  - name: Decisions
    description: Optional preflight checks (no reservation created)
  - name: Reservations
    description: Reservation, commit, release, and (optional) get-by-id operations
  - name: Balances
    description: Query balances for operator visibility
  - name: Events
    description: Optional post-only accounting for non-estimable actions

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Cycles-API-Key

  headers:
    X-Request-Id:
      description: Unique request identifier for debugging
      schema:
        type: string
    X-RateLimit-Remaining:
      description: Number of requests remaining in current window (optional in v0)
      schema:
        type: integer
    X-RateLimit-Reset:
      description: Unix timestamp (seconds) when rate limit resets (optional in v0)
      schema:
        type: integer
        format: int64
    X-Cycles-Tenant:
      description: Effective tenant identifier derived from auth context (optional in v0)
      schema:
        type: string

  parameters:
    IdempotencyKeyHeader:
      name: X-Idempotency-Key
      in: header
      required: false
      description: >-
        Optional idempotency key header. If both header and body idempotency_key are provided, they MUST match.
        Server MUST enforce idempotency per endpoint by (effective tenant, endpoint, idempotency_key).
        On replay of an idempotent request that previously succeeded, server MUST return the original successful
        response payload (including any server-generated identifiers such as reservation_id).
      schema:
        $ref: '#/components/schemas/IdempotencyKey'

    ReservationId:
      name: reservation_id
      in: path
      required: true
      schema:
        type: string
        minLength: 1
        maxLength: 128

    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
      description: Maximum number of results to return

    Cursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string
      description: Opaque cursor from previous response

  responses:
    ErrorResponse:
      description: Error response
      headers:
        X-Request-Id:
          $ref: '#/components/headers/X-Request-Id'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    IdempotencyKey:
      type: string
      minLength: 1
      maxLength: 256

    ErrorCode:
      type: string
      enum:
        - INVALID_REQUEST
        - UNAUTHORIZED
        - FORBIDDEN
        - NOT_FOUND
        - CONFLICT
        - BUDGET_EXCEEDED
        - RESERVATION_EXPIRED
        - RESERVATION_FINALIZED
        - IDEMPOTENCY_MISMATCH
        - UNIT_MISMATCH
        - INTERNAL_ERROR

    ErrorResponse:
      type: object
      required: [error, message, request_id]
      additionalProperties: false
      properties:
        error:
          $ref: '#/components/schemas/ErrorCode'
        message:
          type: string
        request_id:
          type: string
        details:
          type: object
          additionalProperties: true

    DecisionEnum:
      type: string
      enum: [ALLOW, ALLOW_WITH_CAPS, DENY]

    UnitEnum:
      type: string
      description: >
        Standard units.

        USD_MICROCENTS preserves precision for per-call and batched accounting (int64).
          - 1 USD_MICROCENTS = 10^-6 cents = 10^-8 dollars
          - 1 USD = 100 cents = 10^8 USD_MICROCENTS
          - Max int64 ≈ 9.22e18 USD_MICROCENTS ≈ $92.2B

        TOKENS are integer token counts.
        CREDITS/RISK_POINTS are generic integer units (optional in v0 implementations).
      enum: [USD_MICROCENTS, TOKENS, CREDITS, RISK_POINTS]

    Amount:
      type: object
      required: [unit, amount]
      additionalProperties: false
      properties:
        unit:
          $ref: '#/components/schemas/UnitEnum'
        amount:
          type: integer
          format: int64
          minimum: 0

    Subject:
      type: object
      description: >
        Dimension bag for hierarchical budgets. At least one standard field (tenant, workspace, app, workflow, agent, or toolGroup) MUST be provided.
        A subject containing only `dimensions` is invalid; server MUST return 400 INVALID_REQUEST. 
        Hierarchy: tenant → workspace → app → workflow → agent → toolGroup.

        EXTENSIBILITY (v0):
        - dimensions is an optional, user-defined map for alternative taxonomies
          (e.g., cost_center/department/project) and policy/reporting.
        - v0 servers MAY ignore dimensions for budgeting decisions; if they do, they still MUST accept and round-trip it.
        - Keys SHOULD be lowercase and match ^[a-z0-9_.-]+$ for stable canonicalization; values are opaque strings.
      additionalProperties: false
      anyOf:
        - required: [tenant]
        - required: [workspace]
        - required: [app]
        - required: [workflow]
        - required: [agent]
        - required: [toolGroup]
      properties:
        tenant:
          type: string
          maxLength: 128
        workspace:
          type: string
          maxLength: 128
        app:
          type: string
          maxLength: 128
        workflow:
          type: string
          maxLength: 128
        agent:
          type: string
          maxLength: 128
        toolGroup:
          type: string
          maxLength: 128
        dimensions:
          type: object
          description: Optional custom dimensions for enterprise taxonomies and policy/reporting.
          additionalProperties:
            type: string
            maxLength: 256
          maxProperties: 16

    Action:
      type: object
      required: [kind, name]
      additionalProperties: false
      properties:
        kind:
          type: string
          maxLength: 64
          description: >
            Action type identifier. Recommended format: <category>.<operation>
            Examples: llm.completion, llm.embedding, tool.search, tool.calculator,
            db.query, db.write, http.get, http.post, file.upload, message.email, webhook.outbound
        name:
          type: string
          maxLength: 256
          description: Provider/model/tool identifier (e.g., "openai:gpt-4o-mini", "web.search")
        tags:
          type: array
          maxItems: 10
          items:
            type: string
            maxLength: 64
          description: Optional policy tags (e.g., ["prod","customer-facing"])

    Caps:
      type: object
      description: >
        Optional soft-landing constraints returned by /decide or reservation ALLOW_WITH_CAPS.
        v0 intentionally keeps caps simple and concrete (no condition language).

        PRECEDENCE RULES:
        - If tool_allowlist is non-empty, ONLY those tools are allowed (denylist ignored).
        - Otherwise, if tool_denylist is non-empty, all tools EXCEPT those are allowed.
        - If both are empty/null, no tool restrictions apply.
        - Tool names are case-sensitive and match Action.name exactly.
      additionalProperties: false
      properties:
        max_tokens:
          type: integer
          minimum: 0
        max_steps_remaining:
          type: integer
          minimum: 0
        tool_allowlist:
          type: array
          items:
            type: string
            maxLength: 256
        tool_denylist:
          type: array
          items:
            type: string
            maxLength: 256
        cooldown_ms:
          type: integer
          minimum: 0

    # ---- Decide (optional) ----
    DecisionRequest:
      type: object
      required: [idempotency_key, subject, action, estimate]
      additionalProperties: false
      properties:
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
        subject:
          $ref: '#/components/schemas/Subject'
        action:
          $ref: '#/components/schemas/Action'
        estimate:
          $ref: '#/components/schemas/Amount'
        now_ms:
          type: integer
          format: int64
          minimum: 0
        metadata:
          type: object
          additionalProperties: true

    DecisionResponse:
      type: object
      required: [decision]
      additionalProperties: false
      properties:
        decision:
          $ref: '#/components/schemas/DecisionEnum'
        caps:
          $ref: '#/components/schemas/Caps'
        reason_code:
          type: string
          maxLength: 128
          description: Stable machine-readable reason (extensible).
        retry_after_ms:
          type: integer
          minimum: 0
        affected_scopes:
          type: array
          items:
            type: string
          description: Canonical scope identifiers impacted by this decision, in canonical order.

    # ---- Reservations (core) ----
    CommitOveragePolicy:
      type: string
      description: >
        How server handles commits where actual > reserved.
        REJECT: reject commit (client must reserve a buffer or over-estimate).
          Recommended: add 10-20% buffer to estimates when using REJECT.
        ALLOW_IF_AVAILABLE: if remaining budget supports the delta, commit and charge the delta atomically across all derived scopes. 
        The delta check and charge MUST be performed as a single atomic operation; 
        if budget is exhausted between check and commit, server MUST return 409 BUDGET_EXCEEDED.
      enum: [REJECT, ALLOW_IF_AVAILABLE]

    ReservationStatus:
      type: string
      description: Reservation lifecycle state (v1+ may add additional terminal states).
      enum: [ACTIVE, COMMITTED, RELEASED, EXPIRED]

    ReservationCreateRequest:
      type: object
      required: [idempotency_key, subject, action, estimate]
      additionalProperties: false
      properties:
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
        subject:
          $ref: '#/components/schemas/Subject'
        action:
          $ref: '#/components/schemas/Action'
        estimate:
          $ref: '#/components/schemas/Amount'
        ttl_ms:
          type: integer
          minimum: 1000
          maximum: 86400000
          default: 60000
        grace_period_ms:
          type: integer
          minimum: 0
          maximum: 60000
          default: 5000
          description: >
            Grace window after TTL for in-flight commits. Default 5s.
            For high-latency actions (streaming LLM, slow APIs), consider setting higher (10-30s).
        overage_policy:
          $ref: '#/components/schemas/CommitOveragePolicy'
          default: REJECT
        dry_run:
          type: boolean
          default: false
          description: >
            Shadow-mode evaluation. If true, the server MUST evaluate the reservation request and return
            decision/caps/affected_scopes as if it would reserve, but MUST NOT modify balances, persist a
            reservation, or require commit/release. Intended for safe rollout and testing of full reserve-path logic.
        metadata:
          type: object
          additionalProperties: true

    Balance:
      type: object
      required: [scope, scope_path, remaining]
      additionalProperties: false
      description: >-
        Ledger state for a single (scope, unit) balance.

        UNIT CONSISTENCY (NORMATIVE):
          - All Amount fields within a Balance (remaining/reserved/spent/allocated), if present, MUST share the same unit.
          - Servers MUST NOT emit a Balance with mixed units; clients MAY treat such responses as invalid.

        LEDGER INVARIANT (NORMATIVE):
           - If allocated, spent, and reserved are all present, then remaining MUST satisfy: remaining.amount = allocated.amount - spent.amount - reserved.amount (same unit).
           - If allocated is absent, remaining is authoritative and clients MUST treat it as opaque (i.e., MUST NOT derive it from other fields).
           - Servers MUST NOT emit a Balance where the invariant is violated when all four fields are present.
      properties:
        scope:
          type: string
          description: Canonical scope identifier (server-derived), e.g. "tenant:t1", "workflow:run123"
        scope_path:
          type: string
          description: Canonical hierarchical path (server-derived)
        remaining:
          $ref: '#/components/schemas/Amount'
        reserved:
          $ref: '#/components/schemas/Amount'
        spent:
          $ref: '#/components/schemas/Amount'
        allocated:
          $ref: '#/components/schemas/Amount'
          description: Optional if a fixed allocation exists.

    ReservationCreateResponse:
      type: object
      required: [decision]
      additionalProperties: false
      properties:
        decision:
          $ref: '#/components/schemas/DecisionEnum'
        reservation_id:
          type: string
          description: Present if decision is ALLOW or ALLOW_WITH_CAPS and dry_run is false. MUST be absent when dry_run is true.
        reserved:
          $ref: '#/components/schemas/Amount'
        expires_at_ms:
          type: integer
          format: int64
        scope_path:
          type: string
          description: Canonical scope path (server-derived)
        affected_scopes:
          type: array
          items:
            type: string
          description: Canonical scope identifiers impacted by this reservation, in canonical order.
        caps:
          $ref: '#/components/schemas/Caps'
        balances:
          type: array
          items:
            $ref: '#/components/schemas/Balance'
        reason_code:
          type: string
          maxLength: 128
        retry_after_ms:
          type: integer
          minimum: 0

    StandardMetrics:
      type: object
      description: >
        Optional standard metrics for commit/event. All fields are optional.
        Recommended for consistency across clients. For custom fields, use `custom`.
      additionalProperties: false
      properties:
        tokens_input:
          type: integer
          minimum: 0
          description: Input tokens consumed
        tokens_output:
          type: integer
          minimum: 0
          description: Output tokens generated
        latency_ms:
          type: integer
          minimum: 0
          description: Total operation latency in milliseconds
        model_version:
          type: string
          maxLength: 128
          description: Actual model/tool version used
        custom:
          type: object
          additionalProperties: true
          description: Arbitrary additional metrics

    CommitRequest:
      type: object
      required: [idempotency_key, actual]
      additionalProperties: false
      properties:
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
        actual:
          $ref: '#/components/schemas/Amount'
        metrics:
          $ref: '#/components/schemas/StandardMetrics'
        metadata:
          type: object
          additionalProperties: true

    CommitResponse:
      type: object
      required: [status, charged]
      additionalProperties: false
      properties:
        status:
          type: string
          enum: [COMMITTED]
        charged:
          $ref: '#/components/schemas/Amount'
        released:
          $ref: '#/components/schemas/Amount'
          description: Amount returned from over-reservation (if any)
        balances:
          type: array
          items:
            $ref: '#/components/schemas/Balance'

    ReleaseRequest:
      type: object
      required: [idempotency_key]
      additionalProperties: false
      properties:
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
        reason:
          type: string
          maxLength: 256

    ReleaseResponse:
      type: object
      required: [status, released]
      additionalProperties: false
      properties:
        status:
          type: string
          enum: [RELEASED]
        released:
          $ref: '#/components/schemas/Amount'
        balances:
          type: array
          items:
            $ref: '#/components/schemas/Balance'

    ReservationDetail:
      type: object
      description: >
        Reservation details returned by GET /v1/reservations/{reservation_id}. Useful for debugging.
      required:
        - reservation_id
        - status
        - subject
        - action
        - reserved
        - created_at_ms
        - expires_at_ms
        - scope_path
        - affected_scopes
      additionalProperties: false
      properties:
        reservation_id:
          type: string
        status:
          $ref: '#/components/schemas/ReservationStatus'
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
          description: Present if the server persists reservation creation idempotency keys for debugging/recovery.
        subject:
          $ref: '#/components/schemas/Subject'
        action:
          $ref: '#/components/schemas/Action'
        reserved:
          $ref: '#/components/schemas/Amount'
        committed:
          $ref: '#/components/schemas/Amount'
        created_at_ms:
          type: integer
          format: int64
        expires_at_ms:
          type: integer
          format: int64
        finalized_at_ms:
          type: integer
          format: int64
        scope_path:
          type: string
          description: Canonical scope path (server-derived)
        affected_scopes:
          type: array
          items:
            type: string
          description: Canonical scope identifiers impacted by this reservation, in canonical order.
        metadata:
          type: object
          additionalProperties: true

    BalanceResponse:
      type: object
      required: [balances]
      additionalProperties: false
      properties:
        balances:
          type: array
          items:
            $ref: '#/components/schemas/Balance'
        next_cursor:
          type: string
          description: Opaque cursor for next page (if any).
        has_more:
          type: boolean
          description: True if next_cursor is present and more results may be available.

    # ---- Events (optional) ----
    EventCreateRequest:
      type: object
      required: [idempotency_key, subject, action, actual]
      additionalProperties: false
      properties:
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
        subject:
          $ref: '#/components/schemas/Subject'
        action:
          $ref: '#/components/schemas/Action'
        actual:
          $ref: '#/components/schemas/Amount'
        overage_policy:
          $ref: '#/components/schemas/CommitOveragePolicy'
          default: REJECT
          description: >
            How server handles events where actual would exceed remaining budget.
            REJECT (default): server MUST return 409 BUDGET_EXCEEDED if actual > remaining across any derived scope.
            ALLOW_IF_AVAILABLE: server MUST atomically apply the full `actual` amount only if sufficient remaining exists 
            across all derived scopes at apply time; otherwise MUST return 409 BUDGET_EXCEEDED.
        metrics:
          $ref: '#/components/schemas/StandardMetrics'
        now_ms:
          type: integer
          format: int64
          minimum: 0
        metadata:
          type: object
          additionalProperties: true
      description: >
        NOTE: Events MUST be applied atomically across derived scopes (same as reservations), or rejected.

    EventCreateResponse:
      type: object
      required: [status, event_id]
      additionalProperties: false
      properties:
        status:
          type: string
          enum: [APPLIED]
        event_id:
          type: string
        balances:
          type: array
          items:
            $ref: '#/components/schemas/Balance'

    ReservationSummary:
      type: object
      additionalProperties: false
      required:
        - reservation_id
        - status
        - subject
        - action
        - reserved
        - created_at_ms
        - expires_at_ms
        - scope_path
        - affected_scopes
      properties:
        reservation_id:
          type: string
        status:
          $ref: '#/components/schemas/ReservationStatus'
        idempotency_key:
          $ref: '#/components/schemas/IdempotencyKey'
          description: Present if the server persists reservation creation idempotency keys.
        subject:
          $ref: '#/components/schemas/Subject'
        action:
          $ref: '#/components/schemas/Action'
        reserved:
          $ref: '#/components/schemas/Amount'
        created_at_ms:
          type: integer
          format: int64
          minimum: 0
        expires_at_ms:
          type: integer
          format: int64
          minimum: 0
        scope_path:
          type: string
        affected_scopes:
          type: array
          items:
            type: string

    ReservationListResponse:
      type: object
      additionalProperties: false
      required: [reservations]
      properties:
        reservations:
          type: array
          items:
            $ref: '#/components/schemas/ReservationSummary'
        next_cursor:
          type: string
          description: Opaque cursor for next page (if any).
        has_more:
          type: boolean
          description: True if next_cursor is present and more results may be available.

paths:
  /v1/decide:
    post:
      tags: [Decisions]
      operationId: decide
      summary: Optional preflight policy decision (no reservation created)
      description: >-
        Returns ALLOW / DENY, optionally with Caps for soft landing. This endpoint does not reserve budget. Clients that require
        concurrency safety MUST use /v1/reservations.

        IDEMPOTENCY (NORMATIVE): 
        - On replay with the same idempotency_key, the server MUST return the original successful response payload.

        TENANCY (NORMATIVE): 
        - subject.tenant MUST match the effective tenant derived from auth; otherwise the server MUST return 403 FORBIDDEN.

        Idempotency on /decide is for request deduplication only. A replayed ALLOW response reflects budget state at the time of 
        the original call; clients MUST NOT treat a replayed decision as current budget authorization.
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: '#/components/schemas/DecisionRequest'}
      responses:
        "200":
          description: Decision result
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
            X-RateLimit-Remaining: {$ref: '#/components/headers/X-RateLimit-Remaining'}
            X-RateLimit-Reset: {$ref: '#/components/headers/X-RateLimit-Reset'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/DecisionResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "409": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/reservations:
    post:
      tags: [Reservations]
      operationId: createReservation
      summary: Reserve budget for a planned action (concurrency-safe)
      description: >-
        Atomically reserves the estimated amount across server-derived scopes and returns a reservation_id. Reservations expire
        at expires_at_ms; commits are accepted through (expires_at_ms + grace_period_ms). 

        If dry_run=true and decision is ALLOW or ALLOW_WITH_CAPS, server MUST populate affected_scopes, caps (if applicable), 
        and balances as if the reservation were live; reservation_id and expires_at_ms MUST be absent.

        IDEMPOTENCY (NORMATIVE): 
        - On replay with the same idempotency_key, the server MUST return the original successful response payload, 
        including the original reservation_id (if any).

        TENANCY (NORMATIVE): 
        - subject.tenant MUST match the effective tenant derived from auth; otherwise the server MUST return 403 FORBIDDEN.
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: '#/components/schemas/ReservationCreateRequest'}
      responses:
        "200":
          description: Reservation decision (ALLOW/DENY with optional caps)
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/ReservationCreateResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "409": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}
    get:
      tags: [Reservations]
      operationId: listReservations
      summary: List reservations (optional recovery/debug endpoint)
      description: >-
        Lists reservations visible to the effective tenant. This endpoint is OPTIONAL in v0 deployments.


        RECOVERY (NORMATIVE):
          - If a client loses reservation_id, it MAY recover it by querying with idempotency_key and/or subject filters.
          - If idempotency_key is provided, the server SHOULD return at most one matching reservation (uniqueness is expected per (effective tenant, endpoint, idempotency_key)).
          - Servers SHOULD support filtering by status=ACTIVE to identify "stuck" reservations.

        SUBJECT FILTERS (GUIDANCE):
          - Query parameters tenant/workspace/app/workflow/agent/toolGroup filter on the canonical Subject fields.
          - Filtering on Subject.dimensions is out of scope for v0 unless explicitly implemented by the server.

        TENANCY (NORMATIVE):
          - The server MUST scope results to the effective tenant derived from auth.
          - If the tenant query parameter is provided, it is validation-only and MUST match the effective tenant; otherwise the server MUST return 403 FORBIDDEN.
          - If tenant is omitted, the effective tenant is used.
      parameters:
        - name: idempotency_key
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/IdempotencyKey'
          description: Lookup handle to recover the reservation_id from a prior createReservation call.
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ReservationStatus'
          description: Filter by reservation status (e.g., ACTIVE).
        - name: tenant
          in: query
          required: false
          schema: {type: string}
        - name: workspace
          in: query
          required: false
          schema: {type: string}
        - name: app
          in: query
          required: false
          schema: {type: string}
        - name: workflow
          in: query
          required: false
          schema: {type: string}
        - name: agent
          in: query
          required: false
          schema: {type: string}
        - name: toolGroup
          in: query
          required: false
          schema: {type: string}
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        "200":
          description: Reservations list
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/ReservationListResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/reservations/{reservation_id}:
    get:
      tags: [Reservations]
      operationId: getReservation
      summary: Get reservation details (optional, for debugging)
      description: >-
        Retrieve current status and details of a reservation by ID. Useful for debugging and monitoring long-running operations.

        TENANCY (NORMATIVE): 
        - If the reservation exists but is owned by a different effective tenant, the server MUST return 403 FORBIDDEN.
      parameters:
        - $ref: '#/components/parameters/ReservationId'
      responses:
        "200":
          description: Reservation details
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/ReservationDetail'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "404": {$ref: '#/components/responses/ErrorResponse'}
        "410": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/reservations/{reservation_id}/commit:
    post:
      tags: [Reservations]
      operationId: commitReservation
      summary: Commit actual spend for a reservation (auto-releases delta)
      description: >-
        Commits actual spend. If actual < reserved, delta is released automatically. If actual > reserved, behavior is controlled
        by the reservation's overage_policy.

        IDEMPOTENCY (NORMATIVE): 
        - On replay with the same idempotency_key, the server MUST return the original successful response payload.

        TENANCY (NORMATIVE): 
        - If the reservation exists but is owned by a different effective tenant, the server MUST return 403 FORBIDDEN.
      parameters:
        - $ref: '#/components/parameters/ReservationId'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: '#/components/schemas/CommitRequest'}
      responses:
        "200":
          description: Commit succeeded
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/CommitResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "404": {$ref: '#/components/responses/ErrorResponse'}
        "409": {$ref: '#/components/responses/ErrorResponse'}
        "410": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/reservations/{reservation_id}/release:
    post:
      tags: [Reservations]
      operationId: releaseReservation
      summary: Release an unused reservation
      description: >-
        Releases reserved amount back to remaining budget.

        IDEMPOTENCY (NORMATIVE): 
        - On replay with the same idempotency_key, the server MUST return the original successful response payload.

        TENANCY (NORMATIVE): 
        - If the reservation exists but is owned by a different effective tenant, the server MUST return 403 FORBIDDEN.
      parameters:
        - $ref: '#/components/parameters/ReservationId'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: '#/components/schemas/ReleaseRequest'}
      responses:
        "200":
          description: Release succeeded
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/ReleaseResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "404": {$ref: '#/components/responses/ErrorResponse'}
        "409": {$ref: '#/components/responses/ErrorResponse'}
        "410": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/balances:
    get:
      tags: [Balances]
      operationId: getBalances
      summary: Query current budget balances across scopes (nice-to-have)
      description: >
        Returns balances for scopes matching the provided subject filter. At least one subject field must be provided.
        include_children MAY be ignored by v0 implementations.
      parameters:
        - name: tenant
          in: query
          schema: {type: string}
        - name: workspace
          in: query
          schema: {type: string}
        - name: app
          in: query
          schema: {type: string}
        - name: workflow
          in: query
          schema: {type: string}
        - name: agent
          in: query
          schema: {type: string}
        - name: toolGroup
          in: query
          schema: {type: string}
        - name: include_children
          in: query
          schema: {type: boolean, default: false}
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        "200":
          description: Balance response
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/BalanceResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}

  /v1/events:
    post:
      tags: [Events]
      operationId: createEvent
      summary: Optional post-only accounting when pre-estimation is not available
      description: >-
        Records an accounting event without a reservation. This endpoint is optional in v0 deployments. 
        The event MUST be applied atomically across all derived scopes before the server returns 201.

        IDEMPOTENCY (NORMATIVE): 
        - On replay with the same idempotency_key, the server MUST return the original successful response payload.

        TENANCY (NORMATIVE): 
        - subject.tenant MUST match the effective tenant derived from auth; otherwise the server MUST return 403 FORBIDDEN.
      parameters:
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: '#/components/schemas/EventCreateRequest'}
      responses:
        "201":
          description: Event created and atomically applied to balances
          headers:
            X-Request-Id: {$ref: '#/components/headers/X-Request-Id'}
            X-Cycles-Tenant: {$ref: '#/components/headers/X-Cycles-Tenant'}
          content:
            application/json:
              schema: {$ref: '#/components/schemas/EventCreateResponse'}
        "400": {$ref: '#/components/responses/ErrorResponse'}
        "401": {$ref: '#/components/responses/ErrorResponse'}
        "403": {$ref: '#/components/responses/ErrorResponse'}
        "409": {$ref: '#/components/responses/ErrorResponse'}
        "500": {$ref: '#/components/responses/ErrorResponse'}
